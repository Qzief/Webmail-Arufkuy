<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Console - Arufkuy Webmail</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; outline: none; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #0b0f17;
      color: #e8eefc;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* --- UTILS --- */
    .hidden { display: none !important; }
    .muted { opacity: 0.6; font-size: 13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .flex { display: flex; gap: 10px; align-items: center; }
    .flex-col { display: flex; flex-direction: column; gap: 10px; }
    .space-between { justify-content: space-between; }
    .w-full { width: 100%; }
    .mt-4 { margin-top: 16px; }
    .mb-4 { margin-bottom: 16px; }

    /* --- COMPONENTS --- */
    button {
      background: #1a2a52; border: 1px solid #2a3f75; color: #e8eefc;
      padding: 10px 16px; border-radius: 8px; cursor: pointer;
      font-weight: 500; font-size: 13px; transition: all 0.2s;
    }
    button:hover { background: #223460; border-color: #4e7dff; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    button.primary { background: #4e7dff; border-color: #4e7dff; color: #fff; }
    button.primary:hover { background: #3b63d1; }

    button.danger { background: #2a0f0f; border-color: #5a1a1a; color: #ff9b9b; }
    button.danger:hover { background: #3f1515; border-color: #ff4d4d; }

    input {
      background: #0f1626; color: #e8eefc; border: 1px solid #223055;
      border-radius: 8px; padding: 12px; width: 100%; font-size: 14px;
      transition: border-color 0.2s;
    }
    input:focus { border-color: #4e7dff; }
    input[readonly] { opacity: 0.6; cursor: default; }

    .card {
      background: #0f1626; border: 1px solid #1b2640; border-radius: 12px;
      padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    /* --- LOGIN VIEW --- */
    #loginView {
      flex: 1; display: flex; align-items: center; justify-content: center;
      padding: 20px;
    }
    .login-box { width: 100%; max-width: 400px; }
    .brand-logo {
      font-size: 24px; font-weight: 700; margin-bottom: 8px;
      background: linear-gradient(45deg, #4e7dff, #8db0ff);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    /* --- DASHBOARD VIEW --- */
    #dashboardView {
      flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden;
    }

    header {
      height: 60px; border-bottom: 1px solid #1b2640; background: #0b0f17;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; flex-shrink: 0;
    }
    .header-title { font-weight: 600; letter-spacing: 0.5px; display: flex; align-items: center; gap: 10px; }
    .admin-badge {
      font-size: 10px; background: #152248; color: #4e7dff;
      padding: 2px 6px; border-radius: 4px; border: 1px solid #2a3f75;
    }

    .main-content {
      flex: 1; overflow-y: auto; padding: 24px;
      max-width: 1200px; margin: 0 auto; width: 100%;
    }

    .grid-layout {
      display: grid; grid-template-columns: 1fr 2fr; gap: 24px;
    }
    @media (max-width: 900px) { .grid-layout { grid-template-columns: 1fr; } }

    /* Input Group */
    .input-group { display: flex; }
    .input-group input { border-top-right-radius: 0; border-bottom-right-radius: 0; }
    .input-group .addon {
      background: #1b2640; border: 1px solid #223055; border-left: 0;
      color: #8db0ff; padding: 0 16px; display: flex; align-items: center;
      border-top-right-radius: 8px; border-bottom-right-radius: 8px; font-size: 13px;
    }
    .input-group button {
      border-top-left-radius: 0; border-bottom-left-radius: 0;
      border-left: 0;
    }

    /* Table */
    .table-container {
      border: 1px solid #1b2640; border-radius: 8px; overflow: hidden;
      background: #0b1222; margin-top: 16px;
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #1b2640; }
    th { background: #151b2b; color: #8db0ff; font-weight: 600; font-size: 11px; text-transform: uppercase; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: #111827; }

    .status-msg { font-size: 13px; margin-top: 8px; min-height: 20px; }
    .status-msg.error { color: #ff9b9b; }
    .status-msg.success { color: #4caf50; }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 100;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(4px); padding: 20px;
    }
    .modal-box {
      background: #0f1626; padding: 24px; border-radius: 16px;
      border: 1px solid #1b2640; width: 100%; max-width: 500px;
      display: flex; flex-direction: column; gap: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    pre { background: #0b0f17; padding: 12px; border-radius: 8px; overflow: auto; max-height: 300px; font-size: 12px; }

  </style>
</head>
<body>

  <!-- VIEW: LOGIN -->
  <div id="loginView">
    <div class="card login-box text-center">
      <div class="brand-logo">Admin Console</div>
      <div class="muted mb-4">Restricted Access Only</div>

      <form id="loginForm" onsubmit="return false;">
        <div class="flex-col">
          <input id="emailInput" type="email" placeholder="Admin Email" autocomplete="username" required />
          <input id="passwordInput" type="password" placeholder="Password" autocomplete="current-password" required />
          <button id="btnLogin" type="submit" class="primary w-full mt-4">Authenticate</button>
        </div>
      </form>

      <div id="loginMsg" class="status-msg"></div>
    </div>
  </div>

  <!-- VIEW: DASHBOARD -->
  <div id="dashboardView" class="hidden">
    <header>
      <div class="header-title">
        <span>Webmail Admin</span>
        <span class="admin-badge">SUPERUSER</span>
      </div>
      <div class="flex">
        <div class="text-right" style="line-height: 1.2;">
          <div id="adminEmailDisplay" style="font-size: 13px; font-weight: 500;">...</div>
          <div class="muted" style="font-size: 11px;">Logged in</div>
        </div>
        <button id="btnLogout" class="danger" style="padding: 6px 12px; font-size: 11px;">Logout</button>
      </div>
    </header>

    <div class="main-content">

      <div class="grid-layout">

        <!-- Left: Create/Edit User -->
        <div class="flex-col">
          <div class="card">
            <h3 style="margin: 0 0 16px 0; font-size: 16px;">User Mapping</h3>
            <div class="muted mb-4">Map Firebase UID to Inbox Address.</div>

            <div class="flex-col">
              <div>
                <label class="muted">Firebase UID</label>
                <div class="input-group">
                  <input id="targetUid" class="mono" placeholder="Paste User UID" />
                  <button id="btnCheckUid" title="Check if UID exists">Check</button>
                </div>
              </div>

              <div>
                <label class="muted">Username (a-z, 0-9, ., _, -)</label>
                <div class="input-group">
                  <input id="targetLocalPart" placeholder="username" />
                  <div class="addon">@arufkuy.me</div>
                </div>
              </div>

              <div style="padding: 12px; background: #0b1222; border-radius: 8px; border: 1px dashed #223055;">
                <div class="flex space-between mb-4">
                  <span class="muted">Inbox User:</span>
                  <span id="previewUser" class="mono" style="color: #fff;">-</span>
                </div>
                <div class="flex space-between">
                  <span class="muted">Address:</span>
                  <span id="previewAddress" class="mono" style="color: #fff;">-</span>
                </div>
              </div>

              <div class="flex mt-4">
                <button id="btnSave" class="primary w-full">Save & Sync to Worker</button>
                <button id="btnDelete" class="danger" disabled title="Delete Mapping">Del</button>
              </div>
              <div id="actionMsg" class="status-msg text-center"></div>

              <div class="muted text-center" style="font-size: 11px; margin-top: 8px; opacity: 0.5;">
                Note: This will update Firestore AND sync to Worker KV.
              </div>
            </div>
          </div>
        </div>

        <!-- Right: User List -->
        <div class="flex-col">
          <div class="card" style="height: 100%; display: flex; flex-direction: column;">
            <div class="flex space-between">
              <h3 style="margin: 0; font-size: 16px;">Registered Users</h3>
              <button id="btnRefresh" style="padding: 6px 12px; font-size: 11px;">Refresh</button>
            </div>

            <div class="table-container" style="flex: 1; overflow-y: auto;">
              <table>
                <thead>
                  <tr>
                    <th>UID</th>
                    <th>Email Address</th>
                    <th>Inbox User</th>
                    <th style="text-align: right;">Action</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <tr><td colspan="4" class="text-center muted" style="padding: 20px;">Loading data...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

  <!-- Info Modal -->
  <div id="infoModal" class="modal-overlay hidden">
    <div class="modal-box">
      <div class="flex space-between">
        <h3 style="margin:0">Raw Data Inspector</h3>
        <button id="btnCloseModal" style="background:transparent; border:none; color:#8db0ff; padding:0;">âœ•</button>
      </div>
      <div class="muted">Data stored in Firestore for this user:</div>
      <pre id="jsonContent" class="mono"></pre>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAElga8j8thxNtSqFzgfqECu6E6eT8RZFY",
    authDomain: "webmail-arufkuy.firebaseapp.com",
    projectId: "webmail-arufkuy",
    storageBucket: "webmail-arufkuy.firebasestorage.app",
    messagingSenderId: "608495162500",
    appId: "1:608495162500:web:b70eb55061305f83ef5ed1",
    measurementId: "G-JXST3Z88R7"
  };

  const WORKER_API = "https://api.arufkuy.workers.dev";

  // Initialize Admin App (Isolated Auth)
  const app = initializeApp(firebaseConfig, "AdminApp");
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI References
  const $ = (id) => document.getElementById(id);
  const views = {
    login: $("loginView"),
    dashboard: $("dashboardView")
  };

  const els = {
    email: $("emailInput"),
    pass: $("passwordInput"),
    btnLogin: $("btnLogin"),
    loginMsg: $("loginMsg"),
    btnLogout: $("btnLogout"),
    adminEmail: $("adminEmailDisplay"),

    // Form
    uid: $("targetUid"),
    btnCheckUid: $("btnCheckUid"),
    localPart: $("targetLocalPart"),
    previewUser: $("previewUser"),
    previewAddress: $("previewAddress"),
    btnSave: $("btnSave"),
    btnDelete: $("btnDelete"),
    actionMsg: $("actionMsg"),

    // List
    btnRefresh: $("btnRefresh"),
    tableBody: $("usersTableBody"),

    // Modal
    infoModal: $("infoModal"),
    jsonContent: $("jsonContent"),
    btnCloseModal: $("btnCloseModal")
  };

  let currentUser = null;
  let fbToken = null;

  // --- AUTH FLOW ---

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // 1. Check Admin Privileges
      els.loginMsg.textContent = "Verifying privileges...";
      els.btnLogin.disabled = true;

      try {
        const isAdmin = await checkAdmin(user.uid);
        if (isAdmin) {
          currentUser = user;
          fbToken = await user.getIdToken();
          enterDashboard();
        } else {
          throw new Error("Access Denied: Not an admin.");
        }
      } catch (e) {
        console.error(e);
        els.loginMsg.textContent = e.message;
        els.loginMsg.className = "status-msg error";
        await signOut(auth);
        els.btnLogin.disabled = false;
      }
    } else {
      currentUser = null;
      showLogin();
    }
  });

  async function checkAdmin(uid) {
    const snap = await getDoc(doc(db, "admins", uid));
    return snap.exists() && snap.data().isAdmin === true;
  }

  function showLogin() {
    views.dashboard.classList.add("hidden");
    views.login.classList.remove("hidden");
    els.email.value = "";
    els.pass.value = "";
    els.loginMsg.textContent = "";
    els.btnLogin.disabled = false;
    els.btnLogin.textContent = "Authenticate";
  }

  function enterDashboard() {
    views.login.classList.add("hidden");
    views.dashboard.classList.remove("hidden");
    els.adminEmail.textContent = currentUser.email;
    loadUsers();
  }

  // --- WORKER SYNC ---
  async function syncToWorker(uid, inboxUser) {
    // Call Worker Admin API to update KV
    // PUT /admin/allow?uid=...&inboxUser=...
    // Requires Admin Auth (which we assume Worker checks via Token or just open for now if logic allows)
    // NOTE: Your worker code: requireAdmin(request, env) -> returns {ok: true} (OPEN for now)
    // Ideally you should secure this. But for now let's just call it.

    // Since your worker requires Firebase Token for user routes, but Admin routes are currently OPEN in code provided:
    // function requireAdmin(request, env) { return { ok: true }; }
    // So we can just fetch.

    const url = `${WORKER_API}/admin/allow?uid=${encodeURIComponent(uid)}&inboxUser=${encodeURIComponent(inboxUser)}`;
    const res = await fetch(url, { method: "PUT" });
    if (!res.ok) throw new Error(`Worker Sync Failed: ${res.status}`);
    return res.json();
  }

  // --- ACTIONS ---

  els.btnLogin.onclick = async () => {
    const email = els.email.value;
    const pass = els.pass.value;
    if(!email || !pass) return;

    els.btnLogin.disabled = true;
    els.btnLogin.textContent = "Signing in...";
    els.loginMsg.textContent = "";

    try {
      await signInWithEmailAndPassword(auth, email, pass);
      // onAuthStateChanged will handle the rest
    } catch (e) {
      els.loginMsg.textContent = "Login Failed: " + e.message;
      els.loginMsg.className = "status-msg error";
      els.btnLogin.disabled = false;
      els.btnLogin.textContent = "Authenticate";
    }
  };

  els.btnLogout.onclick = () => signOut(auth);

  // Form Logic
  els.localPart.oninput = () => {
    let val = els.localPart.value.toLowerCase();
    // Validate: Only allow a-z, 0-9, ., _, -
    val = val.replace(/[^a-z0-9._-]/g, "");
    els.localPart.value = val;

    if(val) {
      els.previewUser.textContent = val;
      els.previewAddress.textContent = `${val}@arufkuy.me`;
    } else {
      els.previewUser.textContent = "-";
      els.previewAddress.textContent = "-";
    }
  };

  els.btnCheckUid.onclick = async () => {
    const uid = els.uid.value.trim();
    if (!uid) {
      setStatus("Please enter a UID first.", "error");
      return;
    }

    els.btnCheckUid.disabled = true;
    els.btnCheckUid.textContent = "...";

    try {
      const snap = await getDoc(doc(db, "users", uid));
      if (snap.exists()) {
        const data = snap.data();
        setStatus("User found! Loaded data.", "success");
        if (data.email) {
          els.localPart.value = data.email.split('@')[0];
        } else if (data.inboxUser) {
          els.localPart.value = data.inboxUser;
        }
        els.localPart.dispatchEvent(new Event('input'));
        els.btnDelete.disabled = false;
      } else {
        setStatus("User NOT found. Please create mapping.", "error");
        els.localPart.value = "";
        els.localPart.dispatchEvent(new Event('input'));
        els.btnDelete.disabled = true;
      }
    } catch (e) {
      setStatus("Error checking UID: " + e.message, "error");
    } finally {
      els.btnCheckUid.disabled = false;
      els.btnCheckUid.textContent = "Check";
    }
  };

  els.btnSave.onclick = async () => {
    const uid = els.uid.value.trim();
    const local = els.localPart.value.trim().toLowerCase();

    if (!uid || !local) {
      setStatus("All fields required", "error");
      return;
    }

    setStatus("Saving to Firestore...", "");
    els.btnSave.disabled = true;

    try {
      // 1. Save to Firestore
      await setDoc(doc(db, "users", uid), {
        uid: uid,
        email: `${local}@arufkuy.me`,
        inboxUser: local,
        username: local,
        inboxAddress: `${local}@arufkuy.me`,
        updatedAt: serverTimestamp(),
        updatedBy: currentUser.uid
      }, { merge: true });

      // 2. Sync to Worker KV
      setStatus("Syncing to Worker...", "");
      await syncToWorker(uid, local);

      setStatus("User mapped & synced successfully!", "success");
      els.uid.value = "";
      els.localPart.value = "";
      els.localPart.dispatchEvent(new Event('input'));
      els.btnDelete.disabled = true;
      loadUsers();
    } catch (e) {
      setStatus(e.message, "error");
    } finally {
      els.btnSave.disabled = false;
    }
  };

  els.btnDelete.onclick = async () => {
    const uid = els.uid.value.trim();
    if (!uid || !confirm("Delete mapping for this UID?")) return;

    setStatus("Deleting...", "");
    try {
      await deleteDoc(doc(db, "users", uid));
      setStatus("Mapping deleted.", "success");
      els.uid.value = "";
      els.localPart.value = "";
      els.localPart.dispatchEvent(new Event('input'));
      els.btnDelete.disabled = true;
      loadUsers();
    } catch (e) {
      setStatus(e.message, "error");
    }
  };

  // List Logic
  els.btnRefresh.onclick = loadUsers;

  async function loadUsers() {
    els.tableBody.innerHTML = `<tr><td colspan="4" class="text-center muted" style="padding:20px;">Refreshing...</td></tr>`;

    try {
      const q = query(collection(db, "users"), orderBy("updatedAt", "desc"), limit(50));
      const snap = await getDocs(q);

      if (snap.empty) {
        els.tableBody.innerHTML = `<tr><td colspan="4" class="text-center muted" style="padding:20px;">No users found.</td></tr>`;
        return;
      }

      els.tableBody.innerHTML = "";
      snap.forEach(d => {
        const data = d.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="mono" style="font-size:12px; opacity:0.8;">${d.id}</td>
          <td>${data.email || '-'}</td>
          <td class="mono" style="color:#4e7dff;">${data.inboxUser || '-'}</td>
          <td style="text-align:right;">
            <button class="info-btn" style="padding:4px 8px; font-size:11px; margin-right:4px;">Info</button>
            <button class="edit-btn" style="padding:4px 10px; font-size:11px;">Edit</button>
          </td>
        `;

        row.querySelector(".edit-btn").onclick = () => {
          els.uid.value = d.id;
          els.btnCheckUid.click(); // Use check logic to load
        };

        row.querySelector(".info-btn").onclick = () => {
          showInfo(data);
        };

        els.tableBody.appendChild(row);
      });

    } catch (e) {
      els.tableBody.innerHTML = `<tr><td colspan="4" class="text-center error" style="padding:20px;">${e.message}</td></tr>`;
    }
  }

  function showInfo(data) {
    // Convert timestamp to string for display
    const displayData = { ...data };
    if (displayData.updatedAt && displayData.updatedAt.toDate) {
      displayData.updatedAt = displayData.updatedAt.toDate().toISOString();
    }
    els.jsonContent.textContent = JSON.stringify(displayData, null, 2);
    els.infoModal.classList.remove("hidden");
  }

  els.btnCloseModal.onclick = () => {
    els.infoModal.classList.add("hidden");
  };

  function setStatus(msg, type) {
    els.actionMsg.textContent = msg;
    els.actionMsg.className = `status-msg ${type}`;
    if (type === 'success') setTimeout(() => els.actionMsg.textContent = "", 3000);
  }

</script>
</body>
</html>
