<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Webmail Admin (Arufkuy)</title>
  <style>
    :root { color-scheme: dark; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0b0f17; color:#e8eefc; }
    header{
      padding:14px 16px; border-bottom:1px solid #1b2640;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      position:sticky; top:0; background:#0b0f17; z-index:10;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand b{ font-size:14px; letter-spacing:.02em; }
    .right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #2a3f75; opacity:.95; }
    .ok{ border-color:#2f6a3b; } .warn{ border-color:#7a5b2a; } .err{ border-color:#7a2a2a; }

    .wrap{
      max-width:1100px; margin:18px auto; padding:12px;
      display:grid; grid-template-columns: 360px 1fr; gap:12px;
    }
    .card{ background:#0f1626; border:1px solid #1b2640; border-radius:14px; overflow:hidden; }
    .card h2{
      margin:0; font-size:12px; letter-spacing:.08em; text-transform:uppercase;
      padding:12px; border-bottom:1px solid #1b2640; opacity:.85;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .pad{ padding:12px; }
    .muted{ opacity:.72; font-size:12px; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .big{ font-size:16px; font-weight:850; margin:6px 0 10px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr; } .grid2{ grid-template-columns: 1fr; } }

    input{
      width:100%; background:#0f1626; color:#e8eefc; border:1px solid #223055;
      border-radius:10px; padding:11px 12px; outline:none;
    }
    input:focus{ border-color:#4e7dff; }

    /* Input Group for Email */
    .input-group {
      display: flex; align-items: stretch;
      background: #0f1626; border: 1px solid #223055; border-radius: 10px;
      overflow: hidden;
    }
    .input-group input {
      border: none; background: transparent; outline: none;
      flex: 1; border-radius: 0;
    }
    .input-group .addon {
      padding: 0 12px; background: #1b2640; color: #8db0ff;
      font-size: 13px; display: flex; align-items: center;
      border-left: 1px solid #223055;
    }
    .input-group:focus-within { border-color: #4e7dff; }

    button{
      background:#1a2a52; border:1px solid #2a3f75; color:#e8eefc;
      padding:9px 11px; border-radius:10px; cursor:pointer; white-space:nowrap;
    }
    button:hover{ filter:brightness(1.08); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .hr{ height:1px; background:#1b2640; margin:12px 0; }
    .notice{ background:#0b1222; border:1px solid #1b2640; border-radius:12px; padding:10px; }
    .error{ color:#ff9b9b; }
    .okText{ color:#b7ffcc; }
    .table{
      width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px;
      border:1px solid #1b2640; background:#0b1222;
    }
    .table th,.table td{
      padding:10px; border-bottom:1px solid #1b2640; text-align:left; vertical-align:top;
      font-size:12px;
    }
    .table th{ opacity:.85; text-transform:uppercase; letter-spacing:.06em; font-size:11px; }
    .rowActions{ display:flex; gap:8px; flex-wrap:wrap; }
    pre{ white-space:pre-wrap; word-break:break-word; margin:0; }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <b>Webmail Admin</b>
    <span id="badge" class="pill warn">Signed out</span>
  </div>
  <div class="right">
    <span id="who" class="muted"></span>
    <button id="btnLogout" style="display:none">Logout</button>
  </div>
</header>

<div class="wrap">

  <!-- LEFT: LOGIN + STATUS -->
  <section class="card">
    <h2><span>Login</span><span class="muted">Email/Password</span></h2>
    <div class="pad" id="loginBox">
      <div class="muted">Admin Email</div>
      <input id="emailInput" placeholder="admin@email.com" autocomplete="username" />
      <div style="height:10px"></div>

      <div class="muted">Password</div>
      <input id="passwordInput" type="password" placeholder="password" autocomplete="current-password" />
      <div style="height:12px"></div>

      <div class="toolbar">
        <button id="btnLogin">Sign in</button>
        <button id="btnClear">Clear saved</button>
        <span id="loginStatus" class="muted"></span>
      </div>

      <div style="height:10px"></div>
      <div id="loginError" class="error"></div>

      <div class="hr"></div>
      <div class="notice muted">
        Admin ditentukan dari Firestore:
        <div class="mono" style="margin-top:6px">admins/{uid} → { isAdmin: true }</div>
      </div>
    </div>

    <div class="pad" id="adminStatusBox" style="display:none">
      <div class="muted">Signed in as</div>
      <div id="adminEmail" class="big"></div>

      <div class="muted">UID</div>
      <div id="adminUid" class="mono" style="margin-top:6px"></div>

      <div class="hr"></div>

      <div class="muted">Admin status</div>
      <div id="adminStatus" class="big">-</div>
    </div>
  </section>

  <!-- RIGHT: DASHBOARD -->
  <section class="card">
    <h2><span>Account Management</span><span class="muted">Users Mapping</span></h2>
    <div class="pad">

      <div class="notice muted">
        Fungsi admin:
        <div style="margin-top:6px">
          1) Isi UID user (dari Firebase Auth) <br>
          2) Isi Username (otomatis jadi @arufkuy.me) <br>
          3) Simpan ke Firestore <span class="mono">users/{uid}</span>.
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="muted">Target UID</div>
          <input id="targetUid" class="mono" placeholder="paste uid user di sini" />
        </div>
        <div>
          <div class="muted">Target Email</div>
          <div class="input-group">
            <input id="targetLocalPart" placeholder="username" />
            <span class="addon">@arufkuy.me</span>
          </div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="grid2">
        <div>
          <div class="muted">inboxUser (Auto-filled)</div>
          <input id="targetInboxUser" class="mono" placeholder="Auto-filled" readonly style="opacity: 0.7;" />
        </div>
        <div>
          <div class="muted">inboxAddress (Auto-filled)</div>
          <input id="targetInboxAddress" class="mono" placeholder="Auto-filled" readonly style="opacity: 0.7;" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="toolbar">
        <button id="btnSave" disabled>Save / Update</button>
        <button id="btnDelete" disabled>Delete Mapping</button>
        <button id="btnLoad" disabled>Load Mapping</button>
        <span id="actionStatus" class="muted"></span>
      </div>

      <div class="hr"></div>

      <div class="toolbar" style="justify-content:space-between">
        <div>
          <div class="muted">Recent users (from Firestore users collection)</div>
          <div class="muted">(khusus admin, rules membolehkan)</div>
        </div>
        <button id="btnRefreshList" disabled>Refresh List</button>
      </div>

      <div style="height:10px"></div>
      <div style="overflow:auto">
        <table class="table">
          <thead>
            <tr>
              <th>UID</th>
              <th>Email</th>
              <th>inboxUser</th>
              <th>Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTbody">
            <tr><td colspan="5" class="muted">Sign in as admin…</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </section>

</div>

<script type="module">
  // Firebase SDK (module)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc, setDoc, deleteDoc,
    collection, query, orderBy, limit, getDocs,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // === Firebase config kamu ===
  const firebaseConfig = {
    apiKey: "AIzaSyAElga8j8thxNtSqFzgfqECu6E6eT8RZFY",
    authDomain: "webmail-arufkuy.firebaseapp.com",
    projectId: "webmail-arufkuy",
    storageBucket: "webmail-arufkuy.firebasestorage.app",
    messagingSenderId: "608495162500",
    appId: "1:608495162500:web:b70eb55061305f83ef5ed1",
    measurementId: "G-JXST3Z88R7"
  };

  // Initialize with a unique name for Admin to avoid conflict with Client app
  const app = initializeApp(firebaseConfig, "AdminApp");
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM
  const $ = (id) => document.getElementById(id);
  const badge = $("badge");
  const who = $("who");
  const btnLogout = $("btnLogout");

  const loginBox = $("loginBox");
  const adminStatusBox = $("adminStatusBox");

  const emailInput = $("emailInput");
  const passwordInput = $("passwordInput");
  const btnLogin = $("btnLogin");
  const btnClear = $("btnClear");
  const loginStatus = $("loginStatus");
  const loginError = $("loginError");

  const adminEmail = $("adminEmail");
  const adminUid = $("adminUid");
  const adminStatus = $("adminStatus");

  const targetUid = $("targetUid");
  const targetLocalPart = $("targetLocalPart");
  const targetInboxUser = $("targetInboxUser");
  const targetInboxAddress = $("targetInboxAddress");

  const btnSave = $("btnSave");
  const btnDelete = $("btnDelete");
  const btnLoad = $("btnLoad");
  const actionStatus = $("actionStatus");

  const btnRefreshList = $("btnRefreshList");
  const usersTbody = $("usersTbody");

  // state
  let fbUser = null;
  let isAdmin = false;

  function setBadge(kind, text){
    badge.textContent = text;
    badge.classList.remove("ok","warn","err");
    badge.classList.add(kind);
  }

  // AUTO-FILL LOGIC
  targetLocalPart.addEventListener("input", () => {
    const local = targetLocalPart.value.trim().toLowerCase();
    if (local) {
        targetInboxUser.value = local;
        targetInboxAddress.value = `${local}@arufkuy.me`;
    } else {
        targetInboxUser.value = "";
        targetInboxAddress.value = "";
    }
  });

  // LOGIN
  btnLogin.addEventListener("click", async ()=>{
    loginError.textContent = "";
    loginStatus.textContent = "Signing in...";
    try{
      const cred = await signInWithEmailAndPassword(auth, (emailInput.value||"").trim(), passwordInput.value||"");
      fbUser = cred.user;
      who.textContent = fbUser.email || "";
      setBadge("ok","Signed in");
      btnLogout.style.display = "";
      loginStatus.textContent = "OK";
    }catch(e){
      loginStatus.textContent = "";
      loginError.textContent = e.message;
      setBadge("err","Error");
    }
  });

  btnClear.addEventListener("click", ()=>{
    emailInput.value = "";
    passwordInput.value = "";
    loginStatus.textContent = "Cleared.";
  });

  btnLogout.addEventListener("click", async ()=>{
    await signOut(auth).catch(()=>{});
    fbUser = null;
    isAdmin = false;
    setBadge("warn","Signed out");
    who.textContent = "";
    btnLogout.style.display = "none";

    loginBox.style.display = "";
    adminStatusBox.style.display = "none";
    disableAdminUI();
    usersTbody.innerHTML = `<tr><td colspan="5" class="muted">Sign in as admin…</td></tr>`;
  });

  function disableAdminUI(){
    btnSave.disabled = true;
    btnDelete.disabled = true;
    btnLoad.disabled = true;
    btnRefreshList.disabled = true;
  }

  function enableAdminUI(){
    btnSave.disabled = false;
    btnDelete.disabled = false;
    btnLoad.disabled = false;
    btnRefreshList.disabled = false;
  }

  async function checkAdmin(uid){
    const ref = doc(db, "admins", uid);
    const snap = await getDoc(ref);
    if(!snap.exists()) return false;
    const data = snap.data();
    return data?.isAdmin === true;
  }

  // Actions
  btnSave.addEventListener("click", async ()=>{
    actionStatus.textContent = "Saving...";
    try{
      if(!isAdmin) throw new Error("Not admin");

      const uid = (targetUid.value||"").trim();
      const local = (targetLocalPart.value||"").trim().toLowerCase();

      if(!uid) throw new Error("Target UID kosong");
      if(!local) throw new Error("Username kosong");

      const email = `${local}@arufkuy.me`;
      const inboxUser = local;
      const inboxAddress = email;

      // 1) Firestore users/{uid}
      await setDoc(doc(db, "users", uid), {
        email: email,
        inboxUser,
        inboxAddress,
        updatedAt: serverTimestamp(),
        updatedBy: fbUser?.uid || null
      }, { merge: true });

      actionStatus.textContent = "Saved.";
      await refreshUsersList();
    }catch(e){
      actionStatus.textContent = "Error: " + e.message;
      setBadge("err","Error");
    }
  });

  btnLoad.addEventListener("click", async ()=>{
    actionStatus.textContent = "Loading...";
    try{
      if(!isAdmin) throw new Error("Not admin");
      const uid = (targetUid.value||"").trim();
      if(!uid) throw new Error("Target UID kosong");

      const snap = await getDoc(doc(db, "users", uid));
      const fsData = snap.exists() ? snap.data() : null;

      if (fsData && fsData.email) {
          const parts = fsData.email.split("@");
          targetLocalPart.value = parts[0] || "";
          // Trigger input event to update other fields
          targetLocalPart.dispatchEvent(new Event('input'));
      } else {
          targetLocalPart.value = "";
          targetInboxUser.value = "";
          targetInboxAddress.value = "";
      }

      actionStatus.textContent = "Loaded.";
    }catch(e){
      actionStatus.textContent = "Error: " + e.message;
    }
  });

  btnDelete.addEventListener("click", async ()=>{
    actionStatus.textContent = "Deleting...";
    try{
      if(!isAdmin) throw new Error("Not admin");
      const uid = (targetUid.value||"").trim();
      if(!uid) throw new Error("Target UID kosong");
      if(!confirm("Hapus users/{uid} mapping ini?")) return;

      await deleteDoc(doc(db, "users", uid));
      actionStatus.textContent = "Deleted.";
      await refreshUsersList();
    }catch(e){
      actionStatus.textContent = "Error: " + e.message;
    }
  });

  btnRefreshList.addEventListener("click", refreshUsersList);

  async function refreshUsersList(){
    usersTbody.innerHTML = `<tr><td colspan="5" class="muted">Loading…</td></tr>`;
    try{
      const q = query(collection(db, "users"), orderBy("updatedAt", "desc"), limit(25));
      const snap = await getDocs(q);

      const rows = [];
      snap.forEach(docSnap=>{
        const uid = docSnap.id;
        const d = docSnap.data() || {};
        const updated = d.updatedAt?.toDate ? d.updatedAt.toDate().toLocaleString() : "-";
        rows.push({ uid, email: d.email||"-", inboxUser: d.inboxUser||"-", updated });
      });

      if(!rows.length){
        usersTbody.innerHTML = `<tr><td colspan="5" class="muted">No users.</td></tr>`;
        return;
      }

      usersTbody.innerHTML = rows.map(r=>`
        <tr>
          <td class="mono">${escapeHtml(r.uid)}</td>
          <td>${escapeHtml(r.email)}</td>
          <td class="mono">${escapeHtml(r.inboxUser)}</td>
          <td>${escapeHtml(r.updated)}</td>
          <td>
            <div class="rowActions">
              <button data-act="fill" data-uid="${escapeAttr(r.uid)}">Fill</button>
            </div>
          </td>
        </tr>
      `).join("");

      usersTbody.querySelectorAll("button[data-act='fill']").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const uid = btn.getAttribute("data-uid");
          targetUid.value = uid;
          await btnLoad.click();
        });
      });
    }catch(e){
      usersTbody.innerHTML = `<tr><td colspan="5" class="error">Error: ${escapeHtml(e.message)}</td></tr>`;
    }
  }

  function escapeHtml(s){
    return String(s??"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s); }

  // Restore session + check admin
  onAuthStateChanged(auth, async (u)=>{
    fbUser = u;
    if(!u){
      loginBox.style.display = "";
      adminStatusBox.style.display = "none";
      adminEmail.textContent = "";
      adminUid.textContent = "";
      adminStatus.textContent = "-";
      disableAdminUI();
      setBadge("warn","Signed out");
      return;
    }

    // show status
    loginBox.style.display = "none";
    adminStatusBox.style.display = "";
    adminEmail.textContent = u.email || "-";
    adminUid.textContent = u.uid;
    who.textContent = u.email || "";
    btnLogout.style.display = "";
    setBadge("ok","Signed in");

    try{
      isAdmin = await checkAdmin(u.uid);
      adminStatus.textContent = isAdmin ? "ADMIN ✅" : "NOT ADMIN ❌";

      if(!isAdmin){
        disableAdminUI();
        return;
      }

      enableAdminUI();
      await refreshUsersList();
    }catch(e){
      setBadge("err","Error");
      disableAdminUI();
    }
  });
</script>
</body>
</html>
